# ============================================================================
# Design Tokens Notifications Workflow
# ============================================================================
# 
# Este workflow monitora alteraÃ§Ãµes nos tokens do Design System JellyFish
# e envia notificaÃ§Ãµes contextualizadas para o Slack.
#
# ESTRUTURA DO PROJETO:
# design-system/packages/tokens/src/tokens-studio/ - Tokens fonte (Tokens Studio)
# design-system/packages/tokens/build/            - Tokens transformados (Style Dictionary)
#
# SECRETS NECESSÃRIOS:
# - SLACK_WEBHOOK_URL: Webhook URL do Slack para envio de notificaÃ§Ãµes
#
# TROUBLESHOOTING:
# - Se as notificaÃ§Ãµes nÃ£o chegarem, verifique o secret SLACK_WEBHOOK_URL
# - Para debug, cheque os logs do workflow na aba Actions do GitHub
# - Certifique-se que o webhook tem permissÃµes para postar no canal
# ============================================================================

name: Design Tokens Notifications

on:
  # Disparar em push para detectar commits que alteram tokens
  push:
    paths:
      - 'design-system/packages/tokens/src/tokens-studio/**'
      - 'design-system/packages/tokens/build/**'

  # Disparar quando PR Ã© aberta, aprovada ou mergeada
  pull_request:
    types: [opened, closed]
    paths:
      - 'design-system/packages/tokens/src/tokens-studio/**'
      - 'design-system/packages/tokens/build/**'

  # Disparar quando PR recebe review
  pull_request_review:
    types: [submitted]

  # Disparar quando uma release/tag Ã© criada (indicando publicaÃ§Ã£o)
  release:
    types: [published]

  # Disparar quando workflow de build Ã© concluÃ­do (publicaÃ§Ã£o)
  workflow_run:
    workflows: ["Build and Publish Tokens"]  # Ajuste para o nome do seu workflow de publicaÃ§Ã£o
    types:
      - completed

jobs:
  # ==========================================================================
  # JOB 1: Detectar mudanÃ§as e preparar contexto
  # ==========================================================================
  detect-changes:
    name: Detect Token Changes
    runs-on: ubuntu-latest
    outputs:
      tokens_changed: ${{ steps.filter.outputs.tokens }}
      build_changed: ${{ steps.filter.outputs.build }}
      commit_message: ${{ steps.commit-info.outputs.message }}
      commit_author: ${{ steps.commit-info.outputs.author }}
      commit_url: ${{ steps.commit-info.outputs.url }}
      branch_name: ${{ steps.commit-info.outputs.branch }}
    
    steps:
      - name: ðŸ” Debug - Event Information
        run: |
          echo "========================================="
          echo "Event Type: ${{ github.event_name }}"
          echo "Action: ${{ github.event.action }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit SHA: ${{ github.sha }}"
          echo "========================================="

      - name: Checkout repository
        uses: actions/checkout@v4

      # Usar paths-filter para detecÃ§Ã£o precisa de mudanÃ§as
      - name: Check for token changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            tokens:
              - 'design-system/packages/tokens/src/tokens-studio/**'
            build:
              - 'design-system/packages/tokens/build/**'

      - name: ðŸ“‹ Debug - Filter Results
        run: |
          echo "Tokens changed: ${{ steps.filter.outputs.tokens }}"
          echo "Build changed: ${{ steps.filter.outputs.build }}"

      # Extrair informaÃ§Ãµes do commit
      - name: Extract commit information
        id: commit-info
        run: |
          echo "message=${{ github.event.head_commit.message || github.event.pull_request.title }}" >> $GITHUB_OUTPUT
          echo "author=${{ github.event.head_commit.author.name || github.event.pull_request.user.login }}" >> $GITHUB_OUTPUT
          echo "url=${{ github.event.head_commit.url || github.event.pull_request.html_url }}" >> $GITHUB_OUTPUT
          echo "branch=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT

  # ==========================================================================
  # JOB 2: Notificar commits que alteram tokens
  # ==========================================================================
  notify-commit:
    name: Notify Token Commit
    runs-on: ubuntu-latest
    needs: detect-changes
    # Executar apenas em push (nÃ£o em PRs) e se tokens foram alterados
    if: |
      github.event_name == 'push' && 
      (needs.detect-changes.outputs.tokens_changed == 'true' || 
       needs.detect-changes.outputs.build_changed == 'true')
    
    steps:
      - name: Send Slack notification for commit
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ðŸŽ¨ Design Tokens Updated",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Author:*\n${{ needs.detect-changes.outputs.commit_author }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Branch:*\n`${{ needs.detect-changes.outputs.branch_name }}`"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Commit Message:*\n${{ needs.detect-changes.outputs.commit_message }}"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Commit"
                      },
                      "url": "${{ needs.detect-changes.outputs.commit_url }}"
                    }
                  ]
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "Repository: ${{ github.repository }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        continue-on-error: true  # NÃ£o falhar o workflow se Slack estiver indisponÃ­vel

  # ==========================================================================
  # JOB 3: Notificar quando PR de tokens Ã© aberta
  # ==========================================================================
  notify-pr-opened:
    name: Notify PR Opened
    runs-on: ubuntu-latest
    # Executar apenas quando PR Ã© aberta
    if: |
      github.event_name == 'pull_request' && 
      github.event.action == 'opened'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # NecessÃ¡rio para comparar arquivos

      # Contar arquivos alterados
      - name: Count changed files
        id: count-files
        run: |
          FILE_COUNT=$(git diff --name-only origin/${{ github.base_ref }}...origin/${{ github.head_ref }} -- 'design-system/packages/tokens/src/tokens-studio/' | wc -l)
          echo "count=$FILE_COUNT" >> $GITHUB_OUTPUT

      - name: Send Slack notification for PR opened
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ðŸ“ New Token PR Opened",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*${{ github.event.pull_request.title }}*"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Author:*\n${{ github.event.pull_request.user.login }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Files Changed:*\n${{ steps.count-files.outputs.count }} token files"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*From:*\n`${{ github.head_ref }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*To:*\n`${{ github.base_ref }}`"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "Review PR"
                      },
                      "url": "${{ github.event.pull_request.html_url }}",
                      "style": "primary"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Changes"
                      },
                      "url": "${{ github.event.pull_request.html_url }}/files"
                    }
                  ]
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "PR #${{ github.event.pull_request.number }} â€¢ ${{ github.repository }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        continue-on-error: true

  # ==========================================================================
  # JOB 4: Notificar quando PR de tokens Ã© aprovada
  # ==========================================================================
  notify-pr-approved:
    name: Notify PR Approved
    runs-on: ubuntu-latest
    # Executar apenas quando review Ã© submetido e aprovado
    if: |
      github.event_name == 'pull_request_review' && 
      github.event.review.state == 'approved'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Verificar se a PR afeta tokens
      - name: Check if PR affects tokens
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            tokens:
              - 'design-system/packages/tokens/src/tokens-studio/**'
            build:
              - 'design-system/packages/tokens/build/**'

      - name: Send Slack notification for PR approved
        if: steps.filter.outputs.tokens == 'true' || steps.filter.outputs.build == 'true'
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "âœ… Token PR Approved",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*${{ github.event.pull_request.title }}*"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Reviewer:*\n${{ github.event.review.user.login }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*PR Author:*\n${{ github.event.pull_request.user.login }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Review Comment:*\n${{ github.event.review.body || '_No comment provided_' }}"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View PR"
                      },
                      "url": "${{ github.event.pull_request.html_url }}",
                      "style": "primary"
                    }
                  ]
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "PR #${{ github.event.pull_request.number }} â€¢ Ready to merge into `${{ github.event.pull_request.base.ref }}`"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        continue-on-error: true

  # ==========================================================================
  # JOB 5: Notificar quando PR de tokens Ã© mergeada
  # ==========================================================================
  notify-pr-merged:
    name: Notify PR Merged
    runs-on: ubuntu-latest
    # Executar apenas quando PR Ã© fechada E mergeada
    if: |
      github.event_name == 'pull_request' && 
      github.event.action == 'closed' && 
      github.event.pull_request.merged == true
    
    steps:
      - name: Send Slack notification for PR merged
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ðŸŽ‰ Token PR Merged",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*${{ github.event.pull_request.title }}*"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Merged by:*\n${{ github.event.pull_request.merged_by.login }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*PR Author:*\n${{ github.event.pull_request.user.login }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Into:*\n`${{ github.event.pull_request.base.ref }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*From:*\n`${{ github.event.pull_request.head.ref }}`"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Merge Commit"
                      },
                      "url": "${{ github.event.pull_request.merge_commit_sha && format('https://github.com/{0}/commit/{1}', github.repository, github.event.pull_request.merge_commit_sha) || github.event.pull_request.html_url }}",
                      "style": "primary"
                    }
                  ]
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "PR #${{ github.event.pull_request.number }} â€¢ ${{ github.repository }} â€¢ Tokens will be built and published"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        continue-on-error: true

  # ==========================================================================
  # JOB 6: Notificar quando pacote de tokens Ã© publicado
  # ==========================================================================
  notify-package-published:
    name: Notify Package Published
    runs-on: ubuntu-latest
    # Executar quando uma release Ã© publicada
    if: github.event_name == 'release' && github.event.action == 'published'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Extrair versÃ£o do package.json
      - name: Extract package version
        id: package-version
        run: |
          if [ -f "design-system/packages/tokens/package.json" ]; then
            VERSION=$(node -p "require('./design-system/packages/tokens/package.json').version")
            NAME=$(node -p "require('./design-system/packages/tokens/package.json').name")
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "name=$NAME" >> $GITHUB_OUTPUT
          else
            echo "version=unknown" >> $GITHUB_OUTPUT
            echo "name=@jellyfish/tokens" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack notification for package published
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ðŸ“¦ Design Tokens Published",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Package:*\n`${{ steps.package-version.outputs.name }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Version:*\n`${{ steps.package-version.outputs.version }}`"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Release Notes:*\n${{ github.event.release.body || '_No release notes provided_' }}"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Release"
                      },
                      "url": "${{ github.event.release.html_url }}",
                      "style": "primary"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View on npm"
                      },
                      "url": "https://www.npmjs.com/package/${{ steps.package-version.outputs.name }}"
                    }
                  ]
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "Tag: `${{ github.event.release.tag_name }}` â€¢ Published by ${{ github.event.release.author.login }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        continue-on-error: true

  # ==========================================================================
  # JOB 7: Notificar quando workflow de build/publish Ã© concluÃ­do
  # ==========================================================================
  notify-build-completed:
    name: Notify Build Completed
    runs-on: ubuntu-latest
    # Executar quando workflow de build Ã© concluÃ­do com sucesso
    if: |
      github.event_name == 'workflow_run' && 
      github.event.workflow_run.conclusion == 'success'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}

      # Extrair versÃ£o do package.json
      - name: Extract package version
        id: package-version
        run: |
          if [ -f "design-system/packages/tokens/package.json" ]; then
            VERSION=$(node -p "require('./design-system/packages/tokens/package.json').version")
            NAME=$(node -p "require('./design-system/packages/tokens/package.json').name")
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "name=$NAME" >> $GITHUB_OUTPUT
          else
            echo "version=unknown" >> $GITHUB_OUTPUT
            echo "name=@jellyfish/tokens" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack notification for build completed
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ðŸš€ Tokens Build Completed",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Package:*\n`${{ steps.package-version.outputs.name }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Version:*\n`${{ steps.package-version.outputs.version }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Branch:*\n`${{ github.event.workflow_run.head_branch }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Workflow:*\n${{ github.event.workflow_run.name }}"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Workflow Run"
                      },
                      "url": "${{ github.event.workflow_run.html_url }}",
                      "style": "primary"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Commit"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/commit/${{ github.event.workflow_run.head_sha }}"
                    }
                  ]
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "Triggered by ${{ github.event.workflow_run.triggering_actor.login }} â€¢ ${{ github.repository }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        continue-on-error: true