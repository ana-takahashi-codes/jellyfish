# ============================================================================
# Design Tokens Notifications Workflow
# ============================================================================
# 
# Este workflow monitora alteraÃ§Ãµes nos tokens do Design System JellyFish
# e envia notificaÃ§Ãµes contextualizadas para o Slack com detecÃ§Ã£o automÃ¡tica
# de origem (Tokens Studio vs Manual).
#
# ESTRUTURA DO PROJETO:
# design-system/packages/tokens/src/tokens-studio/ - Tokens fonte (Tokens Studio)
# design-system/packages/tokens/build/            - Tokens transformados (Style Dictionary)
#
# SECRETS NECESSÃRIOS:
# - SLACK_WEBHOOK_URL: Webhook URL do Slack para envio de notificaÃ§Ãµes
#
# DETECÃ‡ÃƒO DE ORIGEM:
# O workflow detecta automaticamente se o commit veio do Tokens Studio atravÃ©s de:
# 1. Mensagem de commit (palavras-chave: "tokens studio", "sync tokens", etc)
# 2. Autor do commit (github-actions[bot], tokens-studio-bot)
# 3. Nome da branch (tokens-studio/*, sync/tokens-studio)
# 4. PadrÃ£o de arquivos (3+ arquivos JSON alterados simultaneamente)
#
# TROUBLESHOOTING:
# - Se as notificaÃ§Ãµes nÃ£o chegarem, verifique o secret SLACK_WEBHOOK_URL
# - Para debug, cheque os logs do workflow na aba Actions do GitHub
# - Certifique-se que o webhook tem permissÃµes para postar no canal
# - Verifique se os paths dos tokens estÃ£o corretos para seu projeto
# ============================================================================

name: Design Tokens Notifications

on:
  # Disparar em push para detectar commits que alteram tokens
  push:
    paths:
      - 'design-system/packages/tokens/src/tokens-studio/**'
    branches:
      - '**'  # Todas as branches

  # Disparar quando PR Ã© aberta, aprovada ou mergeada
  pull_request:
    types: [opened, closed]
    paths:
      - 'design-system/packages/tokens/src/tokens-studio/**'

  # Disparar quando PR recebe review
  pull_request_review:
    types: [submitted]

  # Disparar quando uma release/tag Ã© criada (indicando publicaÃ§Ã£o)
  release:
    types: [published]

  # Disparar quando workflow de build Ã© concluÃ­do (publicaÃ§Ã£o)
  workflow_run:
    workflows: ["Build and Publish Tokens"]  # Ajuste para o nome do seu workflow de publicaÃ§Ã£o
    types:
      - completed

jobs:
  # ==========================================================================
  # JOB 1: Detectar origem do commit e tipo de mudanÃ§a
  # ==========================================================================
  detect-commit-source:
    name: Detect Commit Source & Changes
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    outputs:
      is_tokens_studio: ${{ steps.detect.outputs.is_tokens_studio }}
      source_label: ${{ steps.detect.outputs.source_label }}
      source_icon: ${{ steps.detect.outputs.source_icon }}
      source_color: ${{ steps.detect.outputs.source_color }}
      commit_type: ${{ steps.detect.outputs.commit_type }}
      category_icon: ${{ steps.detect.outputs.category_icon }}
      files_changed: ${{ steps.detect.outputs.files_changed }}
      has_breaking_changes: ${{ steps.detect.outputs.has_breaking_changes }}
      breaking_warning: ${{ steps.detect.outputs.breaking_warning }}
      commit_message: ${{ steps.commit-info.outputs.message }}
      commit_author: ${{ steps.commit-info.outputs.author }}
      commit_url: ${{ steps.commit-info.outputs.url }}
      branch_name: ${{ steps.commit-info.outputs.branch }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # NecessÃ¡rio para comparar com commit anterior

      # Extrair informaÃ§Ãµes bÃ¡sicas do commit
      - name: Extract commit information
        id: commit-info
        run: |
          echo "message=${{ github.event.head_commit.message || github.event.pull_request.title }}" >> $GITHUB_OUTPUT
          echo "author=${{ github.event.head_commit.author.name || github.event.pull_request.user.login }}" >> $GITHUB_OUTPUT
          echo "url=${{ github.event.head_commit.url || github.event.pull_request.html_url }}" >> $GITHUB_OUTPUT
          echo "branch=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT

      # Detectar origem do commit e tipo de mudanÃ§a
      - name: Detect commit source and analyze changes
        id: detect
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message || github.event.pull_request.title }}"
          AUTHOR="${{ github.event.head_commit.author.name || github.event.pull_request.user.login }}"
          AUTHOR_EMAIL="${{ github.event.head_commit.author.email || github.event.pull_request.user.email }}"
          BRANCH="${GITHUB_REF#refs/heads/}"
          ACTOR="${{ github.actor }}"
          
          # Obter arquivos alterados
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD -- 'design-system/packages/tokens/src/tokens-studio/')
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD -- 'design-system/packages/tokens/src/tokens-studio/')
          fi
          
          # Contar arquivos JSON alterados
          JSON_COUNT=$(echo "$CHANGED_FILES" | grep -c "\.json$" || echo "0")
          echo "files_changed=$JSON_COUNT" >> $GITHUB_OUTPUT
          
          # ====================================================================
          # DETECTAR CATEGORIA DE TOKENS ALTERADOS
          # ====================================================================
          if echo "$CHANGED_FILES" | grep -qi "color"; then
            CATEGORY="Colors"
            CATEGORY_ICON="ðŸŽ¨"
          elif echo "$CHANGED_FILES" | grep -qi "typography\|font"; then
            CATEGORY="Typography"
            CATEGORY_ICON="ðŸ”¤"
          elif echo "$CHANGED_FILES" | grep -qi "spacing\|space"; then
            CATEGORY="Spacing"
            CATEGORY_ICON="ðŸ“"
          elif echo "$CHANGED_FILES" | grep -qi "border"; then
            CATEGORY="Borders"
            CATEGORY_ICON="ðŸ”²"
          elif echo "$CHANGED_FILES" | grep -qi "shadow"; then
            CATEGORY="Shadows"
            CATEGORY_ICON="ðŸŒ‘"
          elif echo "$CHANGED_FILES" | grep -qi "radius"; then
            CATEGORY="Border Radius"
            CATEGORY_ICON="â­•"
          elif echo "$CHANGED_FILES" | grep -qi "size\|sizing"; then
            CATEGORY="Sizing"
            CATEGORY_ICON="ðŸ“"
          else
            CATEGORY="Tokens"
            CATEGORY_ICON="âš™ï¸"
          fi
          
          echo "commit_type=$CATEGORY" >> $GITHUB_OUTPUT
          echo "category_icon=$CATEGORY_ICON" >> $GITHUB_OUTPUT
          
          # ====================================================================
          # DETECTAR BREAKING CHANGES
          # ====================================================================
          # Verificar se tokens foram removidos (indica possÃ­vel breaking change)
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            REMOVED_LINES=$(git diff origin/${{ github.base_ref }}...HEAD -- 'design-system/packages/tokens/src/tokens-studio/' | grep -c "^-" | grep -v "^---" || echo "0")
          else
            REMOVED_LINES=$(git diff HEAD~1 HEAD -- 'design-system/packages/tokens/src/tokens-studio/' | grep "^-" | grep -v "^---" | wc -l || echo "0")
          fi
          
          if [ "$REMOVED_LINES" -gt 10 ]; then
            echo "has_breaking_changes=true" >> $GITHUB_OUTPUT
            echo "breaking_warning=âš ï¸ Warning: Significant token removals detected ($REMOVED_LINES lines removed)" >> $GITHUB_OUTPUT
          else
            echo "has_breaking_changes=false" >> $GITHUB_OUTPUT
            echo "breaking_warning=" >> $GITHUB_OUTPUT
          fi
          
          # ====================================================================
          # DETECTAR SE VEIO DO TOKENS STUDIO
          # ====================================================================
          IS_STUDIO=false
          
          # 1. Verificar mensagem de commit (palavras-chave comuns de sync)
          if echo "$COMMIT_MSG" | grep -qiE "(tokens studio|tokens-studio|update tokens|sync tokens|tokens update|studio sync|from figma|figma sync|design tokens)"; then
            IS_STUDIO=true
            SOURCE="Tokens Studio"
            ICON="ðŸŽ¨"
            COLOR="#9333EA"  # Roxo do Tokens Studio
          fi
          
          # 2. Verificar autor/email do commit
          if [[ "$AUTHOR" == "github-actions[bot]" ]] || \
             [[ "$AUTHOR" == *"tokens-studio"* ]] || \
             [[ "$AUTHOR" == *"tokens studio"* ]] || \
             [[ "$AUTHOR" == *"figma"* ]] || \
             [[ "$AUTHOR_EMAIL" == *"tokens-studio"* ]] || \
             [[ "$AUTHOR_EMAIL" == *"tokens studio"* ]] || \
             [[ "$AUTHOR_EMAIL" == *"figma"* ]]; then
            IS_STUDIO=true
            SOURCE="Tokens Studio (automated)"
            ICON="ðŸ¤–"
            COLOR="#9333EA"
          fi
          
          # 2a. Verificar actor (GitHub App/bot que executou o workflow)
          if [[ "$ACTOR" == *"tokens-studio"* ]] || \
             [[ "$ACTOR" == *"tokensstudio"* ]] || \
             [[ "$ACTOR" == *"figma"* ]]; then
            IS_STUDIO=true
            SOURCE="Tokens Studio (bot)"
            ICON="ðŸ¤–"
            COLOR="#9333EA"
          fi
          
          # 3. Verificar nome da branch (convenÃ§Ãµes comuns para sync de tokens)
          if [[ "$BRANCH" == *"tokens-studio"* ]] || \
             [[ "$BRANCH" == tokens-studio/* ]] || \
             [[ "$BRANCH" == sync/tokens-studio ]] || \
             [[ "$BRANCH" == *"figma"* ]] || \
             [[ "$BRANCH" == figma/* ]] || \
             [[ "$BRANCH" == design/tokens* ]] || \
             [[ "$BRANCH" == *"design-tokens"* ]]; then
            IS_STUDIO=true
            SOURCE="Tokens Studio Sync"
            ICON="ðŸ”„"
            COLOR="#9333EA"
          fi
          
          # 4. Verificar padrÃ£o de bulk update (3+ arquivos JSON simultaneamente)
          # Tokens Studio geralmente altera vÃ¡rios arquivos de uma vez
          if [ "$JSON_COUNT" -ge 3 ] && [ "$IS_STUDIO" = "false" ]; then
            IS_STUDIO=true
            SOURCE="Tokens Studio (bulk update)"
            ICON="ðŸ“¦"
            COLOR="#9333EA"
          fi
          
          # Se nÃ£o for do Tokens Studio, Ã© ediÃ§Ã£o manual
          if [ "$IS_STUDIO" = "false" ]; then
            SOURCE="Manual Edit"
            ICON="âœï¸"
            COLOR="#2563EB"  # Azul para ediÃ§Ã£o manual
          fi
          
          echo "is_tokens_studio=$IS_STUDIO" >> $GITHUB_OUTPUT
          echo "source_label=$SOURCE" >> $GITHUB_OUTPUT
          echo "source_icon=$ICON" >> $GITHUB_OUTPUT
          echo "source_color=$COLOR" >> $GITHUB_OUTPUT

  # ==========================================================================
  # JOB 2: Notificar commits que alteram tokens
  # ==========================================================================
  notify-commit:
    name: Notify Token Commit
    runs-on: ubuntu-latest
    needs: detect-commit-source
    if: github.event_name == 'push'
    
    steps:
      - name: Send enhanced Slack notification for commit
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "attachments": [
                {
                  "color": "${{ needs.detect-commit-source.outputs.source_color }}",
                  "blocks": [
                    {
                      "type": "header",
                      "text": {
                        "type": "plain_text",
                        "text": "${{ needs.detect-commit-source.outputs.source_icon }} Design Tokens Updated",
                        "emoji": true
                      }
                    },
                    {
                      "type": "section",
                      "fields": [
                        {
                          "type": "mrkdwn",
                          "text": "*Source:*\n${{ needs.detect-commit-source.outputs.source_label }}"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Category:*\n${{ needs.detect-commit-source.outputs.category_icon }} ${{ needs.detect-commit-source.outputs.commit_type }}"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Author:*\n${{ needs.detect-commit-source.outputs.commit_author }}"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Branch:*\n`${{ needs.detect-commit-source.outputs.branch_name }}`"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Files Changed:*\n${{ needs.detect-commit-source.outputs.files_changed }} files"
                        }
                      ]
                    },
                    {
                      "type": "section",
                      "text": {
                        "type": "mrkdwn",
                        "text": "*Commit Message:*\n${{ needs.detect-commit-source.outputs.commit_message }}"
                      }
                    },
                    ${{ needs.detect-commit-source.outputs.has_breaking_changes == 'true' && format('{{ "type": "section", "text": {{ "type": "mrkdwn", "text": "{0}" }} }},', needs.detect-commit-source.outputs.breaking_warning) || '' }}
                    {
                      "type": "actions",
                      "elements": [
                        {
                          "type": "button",
                          "text": {
                            "type": "plain_text",
                            "text": "View Commit"
                          },
                          "url": "${{ needs.detect-commit-source.outputs.commit_url }}",
                          "style": "primary"
                        },
                        {
                          "type": "button",
                          "text": {
                            "type": "plain_text",
                            "text": "View Changes"
                          },
                          "url": "${{ needs.detect-commit-source.outputs.commit_url }}/files"
                        }
                      ]
                    },
                    {
                      "type": "context",
                      "elements": [
                        {
                          "type": "mrkdwn",
                          "text": "${{ github.repository }} â€¢ ${{ github.event.head_commit.id }}"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        continue-on-error: true  # NÃ£o falhar o workflow se Slack estiver indisponÃ­vel

  # ==========================================================================
  # JOB 3: Notificar quando PR de tokens Ã© aberta
  # ==========================================================================
  notify-pr-opened:
    name: Notify PR Opened
    runs-on: ubuntu-latest
    needs: detect-commit-source
    if: |
      github.event_name == 'pull_request' && 
      github.event.action == 'opened'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # NecessÃ¡rio para comparar arquivos

      # Contar arquivos alterados
      - name: Count changed files
        id: count-files
        run: |
          FILE_COUNT=$(git diff --name-only origin/${{ github.base_ref }}...origin/${{ github.head_ref }} -- 'design-system/packages/tokens/src/tokens-studio/' | wc -l)
          echo "count=$FILE_COUNT" >> $GITHUB_OUTPUT

      - name: Send Slack notification for PR opened
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "attachments": [
                {
                  "color": "${{ needs.detect-commit-source.outputs.source_color }}",
                  "blocks": [
                    {
                      "type": "header",
                      "text": {
                        "type": "plain_text",
                        "text": "ðŸ“ New Token PR Opened",
                        "emoji": true
                      }
                    },
                    {
                      "type": "section",
                      "text": {
                        "type": "mrkdwn",
                        "text": "*${{ github.event.pull_request.title }}*"
                      }
                    },
                    {
                      "type": "section",
                      "fields": [
                        {
                          "type": "mrkdwn",
                          "text": "*Source:*\n${{ needs.detect-commit-source.outputs.source_label }}"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Category:*\n${{ needs.detect-commit-source.outputs.category_icon }} ${{ needs.detect-commit-source.outputs.commit_type }}"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Author:*\n${{ github.event.pull_request.user.login }}"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Files Changed:*\n${{ steps.count-files.outputs.count }} token files"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*From:*\n`${{ github.head_ref }}`"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*To:*\n`${{ github.base_ref }}`"
                        }
                      ]
                    },
                    ${{ needs.detect-commit-source.outputs.has_breaking_changes == 'true' && format('{{ "type": "section", "text": {{ "type": "mrkdwn", "text": "{0}" }} }},', needs.detect-commit-source.outputs.breaking_warning) || '' }}
                    {
                      "type": "actions",
                      "elements": [
                        {
                          "type": "button",
                          "text": {
                            "type": "plain_text",
                            "text": "Review PR"
                          },
                          "url": "${{ github.event.pull_request.html_url }}",
                          "style": "primary"
                        },
                        {
                          "type": "button",
                          "text": {
                            "type": "plain_text",
                            "text": "View Changes"
                          },
                          "url": "${{ github.event.pull_request.html_url }}/files"
                        }
                      ]
                    },
                    {
                      "type": "context",
                      "elements": [
                        {
                          "type": "mrkdwn",
                          "text": "PR #${{ github.event.pull_request.number }} â€¢ ${{ github.repository }}"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        continue-on-error: true

  # ==========================================================================
  # JOB 4: Notificar quando PR de tokens Ã© aprovada
  # ==========================================================================
  notify-pr-approved:
    name: Notify PR Approved
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request_review' && 
      github.event.review.state == 'approved'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Verificar se a PR afeta tokens
      - name: Check if PR affects tokens
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            tokens:
              - 'design-system/packages/tokens/src/tokens-studio/**'

      - name: Send Slack notification for PR approved
        if: steps.filter.outputs.tokens == 'true'
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "attachments": [
                {
                  "color": "#16A34A",
                  "blocks": [
                    {
                      "type": "header",
                      "text": {
                        "type": "plain_text",
                        "text": "âœ… Token PR Approved",
                        "emoji": true
                      }
                    },
                    {
                      "type": "section",
                      "text": {
                        "type": "mrkdwn",
                        "text": "*${{ github.event.pull_request.title }}*"
                      }
                    },
                    {
                      "type": "section",
                      "fields": [
                        {
                          "type": "mrkdwn",
                          "text": "*Reviewer:*\n${{ github.event.review.user.login }}"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*PR Author:*\n${{ github.event.pull_request.user.login }}"
                        }
                      ]
                    },
                    {
                      "type": "section",
                      "text": {
                        "type": "mrkdwn",
                        "text": "*Review Comment:*\n${{ github.event.review.body || '_No comment provided_' }}"
                      }
                    },
                    {
                      "type": "actions",
                      "elements": [
                        {
                          "type": "button",
                          "text": {
                            "type": "plain_text",
                            "text": "View PR"
                          },
                          "url": "${{ github.event.pull_request.html_url }}",
                          "style": "primary"
                        }
                      ]
                    },
                    {
                      "type": "context",
                      "elements": [
                        {
                          "type": "mrkdwn",
                          "text": "PR #${{ github.event.pull_request.number }} â€¢ Ready to merge into `${{ github.event.pull_request.base.ref }}`"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        continue-on-error: true

  # ==========================================================================
  # JOB 5: Notificar quando PR de tokens Ã© mergeada
  # ==========================================================================
  notify-pr-merged:
    name: Notify PR Merged
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' && 
      github.event.action == 'closed' && 
      github.event.pull_request.merged == true
    
    steps:
      - name: Send Slack notification for PR merged
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "attachments": [
                {
                  "color": "#7C3AED",
                  "blocks": [
                    {
                      "type": "header",
                      "text": {
                        "type": "plain_text",
                        "text": "ðŸŽ‰ Token PR Merged",
                        "emoji": true
                      }
                    },
                    {
                      "type": "section",
                      "text": {
                        "type": "mrkdwn",
                        "text": "*${{ github.event.pull_request.title }}*"
                      }
                    },
                    {
                      "type": "section",
                      "fields": [
                        {
                          "type": "mrkdwn",
                          "text": "*Merged by:*\n${{ github.event.pull_request.merged_by.login }}"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*PR Author:*\n${{ github.event.pull_request.user.login }}"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Into:*\n`${{ github.event.pull_request.base.ref }}`"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*From:*\n`${{ github.event.pull_request.head.ref }}`"
                        }
                      ]
                    },
                    {
                      "type": "actions",
                      "elements": [
                        {
                          "type": "button",
                          "text": {
                            "type": "plain_text",
                            "text": "View Merge Commit"
                          },
                          "url": "${{ github.event.pull_request.merge_commit_sha && format('https://github.com/{0}/commit/{1}', github.repository, github.event.pull_request.merge_commit_sha) || github.event.pull_request.html_url }}",
                          "style": "primary"
                        }
                      ]
                    },
                    {
                      "type": "context",
                      "elements": [
                        {
                          "type": "mrkdwn",
                          "text": "PR #${{ github.event.pull_request.number }} â€¢ ${{ github.repository }} â€¢ Tokens will be built and published"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        continue-on-error: true

  # ==========================================================================
  # JOB 6: Notificar quando pacote de tokens Ã© publicado via Release
  # ==========================================================================
  notify-package-published:
    name: Notify Package Published
    runs-on: ubuntu-latest
    if: github.event_name == 'release' && github.event.action == 'published'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Extrair versÃ£o do package.json
      - name: Extract package version
        id: package-version
        run: |
          if [ -f "design-system/packages/tokens/package.json" ]; then
            VERSION=$(node -p "require('./design-system/packages/tokens/package.json').version")
            NAME=$(node -p "require('./design-system/packages/tokens/package.json').name")
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "name=$NAME" >> $GITHUB_OUTPUT
          else
            echo "version=unknown" >> $GITHUB_OUTPUT
            echo "name=@jellyfish/tokens" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack notification for package published
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "attachments": [
                {
                  "color": "#EA580C",
                  "blocks": [
                    {
                      "type": "header",
                      "text": {
                        "type": "plain_text",
                        "text": "ðŸ“¦ Design Tokens Published",
                        "emoji": true
                      }
                    },
                    {
                      "type": "section",
                      "fields": [
                        {
                          "type": "mrkdwn",
                          "text": "*Package:*\n`${{ steps.package-version.outputs.name }}`"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Version:*\n`${{ steps.package-version.outputs.version }}`"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Published by:*\n${{ github.event.release.author.login }}"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Tag:*\n`${{ github.event.release.tag_name }}`"
                        }
                      ]
                    },
                    {
                      "type": "section",
                      "text": {
                        "type": "mrkdwn",
                        "text": "*Release Notes:*\n${{ github.event.release.body || '_No release notes provided_' }}"
                      }
                    },
                    {
                      "type": "actions",
                      "elements": [
                        {
                          "type": "button",
                          "text": {
                            "type": "plain_text",
                            "text": "View Release"
                          },
                          "url": "${{ github.event.release.html_url }}",
                          "style": "primary"
                        },
                        {
                          "type": "button",
                          "text": {
                            "type": "plain_text",
                            "text": "View on npm"
                          },
                          "url": "https://www.npmjs.com/package/${{ steps.package-version.outputs.name }}"
                        }
                      ]
                    },
                    {
                      "type": "context",
                      "elements": [
                        {
                          "type": "mrkdwn",
                          "text": "ðŸŽŠ New version available! Update your dependencies to get the latest tokens."
                        }
                      ]
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        continue-on-error: true

  # ==========================================================================
  # JOB 7: Notificar quando workflow de build/publish Ã© concluÃ­do
  # ==========================================================================
  notify-build-completed:
    name: Notify Build Completed
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_run' && 
      github.event.workflow_run.conclusion == 'success'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}

      # Extrair versÃ£o do package.json
      - name: Extract package version
        id: package-version
        run: |
          if [ -f "design-system/packages/tokens/package.json" ]; then
            VERSION=$(node -p "require('./design-system/packages/tokens/package.json').version")
            NAME=$(node -p "require('./design-system/packages/tokens/package.json').name")
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "name=$NAME" >> $GITHUB_OUTPUT
          else
            echo "version=unknown" >> $GITHUB_OUTPUT
            echo "name=@jellyfish/tokens" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack notification for build completed
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "attachments": [
                {
                  "color": "#059669",
                  "blocks": [
                    {
                      "type": "header",
                      "text": {
                        "type": "plain_text",
                        "text": "ðŸš€ Tokens Build Completed",
                        "emoji": true
                      }
                    },
                    {
                      "type": "section",
                      "fields": [
                        {
                          "type": "mrkdwn",
                          "text": "*Package:*\n`${{ steps.package-version.outputs.name }}`"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Version:*\n`${{ steps.package-version.outputs.version }}`"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Branch:*\n`${{ github.event.workflow_run.head_branch }}`"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*Workflow:*\n${{ github.event.workflow_run.name }}"
                        }
                      ]
                    },
                    {
                      "type": "actions",
                      "elements": [
                        {
                          "type": "button",
                          "text": {
                            "type": "plain_text",
                            "text": "View Workflow Run"
                          },
                          "url": "${{ github.event.workflow_run.html_url }}",
                          "style": "primary"
                        },
                        {
                          "type": "button",
                          "text": {
                            "type": "plain_text",
                            "text": "View Commit"
                          },
                          "url": "${{ format('{0}/{1}/commit/{2}', github.server_url, github.repository, github.event.workflow_run.head_sha) }}"
                        }
                      ]
                    },
                    {
                      "type": "context",
                      "elements": [
                        {
                          "type": "mrkdwn",
                          "text": "Triggered by ${{ github.event.workflow_run.triggering_actor.login }} â€¢ ${{ github.repository }}"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        continue-on-error: true